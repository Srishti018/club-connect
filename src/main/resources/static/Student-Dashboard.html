<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>CBIT – Student Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
          --bg:#0f1b2b; --panel:#12233a; --ink:#e8f0ff; --muted:#a9b7d1;
          --accent:#1e66ff; --accent-2:#2dd4bf; --danger:#ef4444; --ok:#10b981;
          --border:rgba(255,255,255,.08);
        }
        *{box-sizing:border-box}
        body{
          margin:0; background:var(--bg); color:var(--ink);
          font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;
        }
        .wrap{max-width:1200px; margin:28px auto; padding:0 20px}
        header h1{margin:0 0 6px; font-size:32px; color:var(--accent);}
        header small{color:var(--muted)}
        .grid{display:grid; grid-template-columns:360px 1fr; gap:24px; margin-top:24px}
        @media (max-width:980px){.grid{grid-template-columns:1fr}}

        .card{background:var(--panel); border:1px solid var(--border);
          border-radius:14px; padding:18px 18px 8px}
        .card h2{margin:0 0 12px; font-size:22px; color:var(--accent);}
        .subtle{color:var(--muted)}

        .club{padding:12px 8px; border-bottom:1px dashed var(--border); cursor:pointer; transition:background .2s ease;}
        .club:hover{background:rgba(30,102,255,.1);}
        .club-name{font-weight:700}
        .club-desc{color:var(--muted); margin-top:4px; font-size:14px}

        .evt{padding:16px; border:1px solid var(--border); border-radius:12px;
          margin:12px 0; background:rgba(255,255,255,.02); cursor:pointer;
          transition:background .2s ease;}
        .evt:hover{background:rgba(30,102,255,.1);}
        .evt-title{font-weight:800; font-size:20px; margin:0 0 8px}
        .evt-meta{color:var(--muted); font-size:14px; display:flex; gap:18px; flex-wrap:wrap}
        .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px}
        .btn{
          appearance:none; border:0; background:var(--accent); color:white;
          padding:10px 16px; border-radius:10px; font-weight:700;
          cursor:pointer; transition:transform .06s ease,opacity .2s;
        }
        .btn:active{transform:translateY(1px)}
        .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--border)}
        .empty{color:var(--muted); padding:18px 12px}
        .error{background:rgba(239,68,68,.12); border:1px dashed rgba(239,68,68,.5);
          color:#fecaca; padding:12px 14px; border-radius:10px; margin:12px 0}
        .header-row{display:flex; align-items:center; justify-content:space-between; gap:12px}
        .count{color:var(--muted); font-size:14px}

        /* Modal */
        .modal {
          position:fixed; top:0; left:0; width:100%; height:100%;
          background:rgba(0,0,0,0.6); display:none; align-items:center;
          justify-content:center; z-index:1000;
        }
        .modal-content {
          background:var(--panel); border-radius:12px; padding:24px; max-width:600px;
          box-shadow:0 0 20px rgba(0,0,0,0.4); position:relative;
        }
        .modal h3{margin-top:0; color:var(--accent);}
        .modal p{color:var(--ink);}
        .close-btn {
          background:transparent; color:var(--muted); border:0; font-size:20px;
          position:absolute; top:20px; right:30px; cursor:pointer;
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>Student Dashboard — Upcoming Events</h1>
        <small class="subtle">CBIT-Club-Connect</small>
    </header>

    <section class="grid">
        <!-- Clubs Section -->
        <aside class="card" id="clubsCard">
            <div class="header-row">
                <h2>Clubs</h2>
                <button class="btn ghost" id="btnAllEvents">All Events</button>
            </div>
            <div id="clubsList" class="list"><div class="empty">Loading clubs…</div></div>
        </aside>

        <!-- Events Section -->
        <main class="card">
            <div class="header-row">
                <h2>Upcoming Events</h2>
                <div class="count"><span id="eventsCount">0</span> events</div>
            </div>
            <div id="eventsHost"><div class="empty">Loading events…</div></div>
        </main>
    </section>
</div>

<!-- Modal for Event Description -->
<div class="modal" id="eventModal">
    <div class="modal-content">
        <button class="close-btn" id="closeModal">&times;</button>
        <h3 id="modalTitle"></h3>
        <p id="modalDescription"></p>
    </div>
</div>

<script>
    const clubsHost = document.getElementById('clubsList');
    const eventsHost = document.getElementById('eventsHost');
    const eventsCount = document.getElementById('eventsCount');
    const btnAllEvents = document.getElementById('btnAllEvents');
    const modal = document.getElementById('eventModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const closeModal = document.getElementById('closeModal');

    let allEvents = [];

    const fmt = new Intl.DateTimeFormat(undefined, {dateStyle:'medium', timeStyle:'short'});
    const toLocal = dt => { try { return fmt.format(new Date(dt)); } catch { return dt || ''; } };
    const el = (tag, cls, text) => { const e=document.createElement(tag); if(cls)e.className=cls; if(text)e.textContent=text; return e; };
    const showError = (host, text) => { host.innerHTML=''; host.appendChild(el('div','error',text)); };

    function renderClubs(clubs){
      clubsHost.innerHTML='';
      if(!clubs?.length){ clubsHost.appendChild(el('div','empty','No clubs configured.')); return; }

      clubs.forEach(c=>{
        const row=el('div','club');
        row.appendChild(el('div','club-name',c.name||'Club'));
        row.appendChild(el('div','club-desc',c.description||''));
        row.addEventListener('click', ()=> filterEventsByClub(c.name));
        clubsHost.appendChild(row);
      });
    }

    function renderEvents(list){
      eventsHost.innerHTML='';
      eventsCount.textContent=list?.length??0;
      if(!list?.length){ eventsHost.appendChild(el('div','empty','No upcoming events.')); return; }

      list.forEach(e=>{
        const card=el('div','evt');
        card.addEventListener('click',()=>{
          modal.style.display='flex';
          modalTitle.textContent=e.title||'Event';
          modalDescription.textContent=e.description||'No description available.';
        });

        const title=el('div','evt-title',e.title||'Event');
        card.appendChild(title);

        const meta=el('div','evt-meta');
        if(e.dateTime) meta.appendChild(el('span','',`Date: ${toLocal(e.dateTime)}`));
        if(e.venue) meta.appendChild(el('span','',`Venue: ${e.venue}`));
        if(e.clubName) meta.appendChild(el('span','',`Club: ${e.clubName}`));
        if(e.activityPoints!=null) meta.appendChild(el('span','',`Activity Points: ${e.activityPoints}`));
        card.appendChild(meta);

        const actions=el('div','row');
        const reg=el('button','btn','Register');
        reg.addEventListener('click',(ev)=>{
          ev.stopPropagation();
          if(!e.id){ alert('Invalid event.'); return; }
          window.location.href=`registration.html?eventId=${encodeURIComponent(e.id)}`;
        });
        actions.appendChild(reg);
        card.appendChild(actions);
        eventsHost.appendChild(card);
      });
    }

    function filterEventsByClub(clubName){
      const filtered = allEvents.filter(e => e.clubName === clubName);
      renderEvents(filtered);
    }

    async function loadClubs(){
      try{
        const r=await fetch('/api/public/clubs');
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        renderClubs(await r.json());
      }catch(err){ showError(clubsHost,`Failed to load clubs: ${err.message}`); }
    }

    async function loadEvents(){
      try{
        const r=await fetch('/api/public/events');
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        allEvents = await r.json();
        renderEvents(allEvents);
      }catch(err){
        showError(eventsHost,`Failed to load upcoming events: ${err.message}`);
        eventsCount.textContent=0;
      }
    }

    closeModal.addEventListener('click',()=>modal.style.display='none');
    modal.addEventListener('click',(e)=>{if(e.target===modal)modal.style.display='none';});
    btnAllEvents.addEventListener('click',()=>renderEvents(allEvents));

    loadClubs();
    loadEvents();
</script>
</body>
</html>
