<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Attendance | CBIT CLUB CONNECT</title>
    <style>
        :root {
          --accent: #14b8a6;
          --accent-hover: #0d9488;
          --radius: 14px;
          --shadow-3d: 0 8px 20px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08);
          --transition: all 0.25s ease;

          /* Light mode */
          --bg: #f1f6ff;
          --panel: #ffffff;
          --ink: #0f172a;
          --muted: #475569;
          --border: #dce3f0;
        }

        /* Dark mode */
        [data-theme="dark"] {
          --bg: #0b1622;
          --panel: #142236;
          --ink: #e2e8f0;
          --muted: #94a3b8;
          --border: #1e293b;
          --shadow-3d: 0 10px 24px rgba(0,0,0,0.45), 0 6px 10px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; transition: var(--transition); }
        body {
          margin: 0;
          background: var(--bg);
          color: var(--ink);
          font-family: "Inter", system-ui, sans-serif;
        }

        /* Header */
        header {
          background: linear-gradient(90deg, var(--accent), var(--accent-hover));
          color: #fff;
          text-align: center;
          padding: 20px 30px;
          font-size: 28px;
          font-weight: 900;
          letter-spacing: 1px;
          text-transform: uppercase;
          box-shadow: var(--shadow-3d);
        }

        /* Layout */
        .wrap {
          max-width: 960px;
          margin: 40px auto;
          padding: 0 20px 40px;
        }

        /* Cards */
        .card {
          background: var(--panel);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          padding: 20px;
          box-shadow: var(--shadow-3d);
        }

        /* Titles */
        h1 {
          margin: 0 0 12px;
          font-size: 26px;
          color: var(--accent);
        }
        .status {
          font-size: 15px;
          color: var(--muted);
          margin-top: 8px;
        }

        /* Table */
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 12px;
          border-radius: var(--radius);
          overflow: hidden;
        }
        th, td {
          padding: 12px 10px;
          border-bottom: 1px solid var(--border);
          text-align: left;
        }
        th {
          background: rgba(20,184,166,0.08);
          color: var(--accent);
          font-weight: 600;
        }
        tr:hover {
          background: rgba(20,184,166,0.05);
        }
        td {
          color: var(--ink);
        }

        /* Buttons */
        .btn {
          padding: 10px 18px;
          border-radius: 8px;
          border: none;
          font-weight: 600;
          cursor: pointer;
          margin-right: 8px;
          transition: var(--transition);
        }
        .btn-primary {
          background: linear-gradient(145deg, var(--accent), var(--accent-hover));
          color: #fff;
          box-shadow: var(--shadow-3d);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-ghost {
          background: transparent;
          border: 1.5px solid var(--accent);
          color: var(--accent);
        }
        .btn-ghost:hover {
          background: var(--accent);
          color: #fff;
        }
        input[type="checkbox"] {
          transform: scale(1.3);
          cursor: pointer;
        }

        /* Theme toggle */
        .theme-toggle {
          position: fixed;
          top: 20px;
          right: 20px;
          width: 44px;
          height: 44px;
          border-radius: 50%;
          border: none;
          background: var(--panel);
          color: var(--ink);
          font-size: 20px;
          box-shadow: var(--shadow-3d);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .theme-toggle:hover { transform: scale(1.08); }
    </style>
</head>

<body>
<header>CBIT CLUB CONNECT</header>
<button id="themeToggle" class="theme-toggle" title="Toggle theme">üåô</button>

<div class="wrap">
    <h1>Attendance Management</h1>
    <div id="eventInfo" class="status">Loading event info...</div>

    <div class="card" style="margin-top:20px;">
        <table id="attendanceTable">
            <thead>
            <tr><th>#</th><th>Student Name</th><th>Roll No</th><th style="text-align:center;">Present</th></tr>
            </thead>
            <tbody id="attendanceBody">
            <tr><td colspan="4" class="status">Loading students...</td></tr>
            </tbody>
        </table>

        <div style="margin-top:20px;">
            <button class="btn btn-primary" id="saveBtn">Save Attendance</button>
            <button class="btn btn-ghost" onclick="goBack()">Back</button>
        </div>
        <div id="statusMsg" class="status"></div>
    </div>
</div>

<script>
    /* --- Theme setup --- */
    const body=document.body;
    const toggle=document.getElementById("themeToggle");
    const saved=localStorage.getItem("theme");
    if(saved){
      body.setAttribute("data-theme",saved);
      toggle.textContent=saved==="dark"?"‚òÄÔ∏è":"üåô";
    }else if(window.matchMedia("(prefers-color-scheme: dark)").matches){
      body.setAttribute("data-theme","dark");
      toggle.textContent="‚òÄÔ∏è";
    }
    toggle.addEventListener("click",()=>{
      const now=body.getAttribute("data-theme");
      const next=now==="dark"?"light":"dark";
      body.setAttribute("data-theme",next);
      localStorage.setItem("theme",next);
      toggle.textContent=next==="dark"?"‚òÄÔ∏è":"üåô";
    });

    /* --- Attendance logic --- */
    const qs=new URLSearchParams(window.location.search);
    const eventId=qs.get('eventId');
    const clubId=qs.get('clubId');
    const tbody=document.getElementById('attendanceBody');
    const eventInfo=document.getElementById('eventInfo');
    const statusMsg=document.getElementById('statusMsg');
    let attendanceMap={};

    if(!eventId){
      alert('Missing eventId');
      window.location.href='/club-dashboard.html';
    }

    async function loadEventInfo(){
      try{
        const r=await fetch(`/api/events/${eventId}`);
        if(!r.ok)throw new Error();
        const e=await r.json();
        eventInfo.textContent=`${e.name} ‚Äî ${new Date(e.startAt).toLocaleString()}`;
      }catch{
        eventInfo.textContent='Unable to load event info.';
      }
    }

    async function loadAttendance(){
      try{
        const res=await fetch(`/attendance/event/${eventId}`);
        if(res.ok){
          const data=await res.json();
          data.forEach(a=>{
            const uid=a.userId||a.user?.id;
            if(uid) attendanceMap[uid]=a.present;
          });
        }
      }catch(err){console.error("Error loading attendance:",err);}
    }

    async function loadStudents(){
      try{
        await loadAttendance();
        const r=await fetch(`/attendance/event/${eventId}/registrations`);
        if(!r.ok)throw new Error('Could not load student list');
        const students=await r.json();
        renderStudents(students);
      }catch(err){
        console.error(err);
        tbody.innerHTML=`<tr><td colspan="4" class="status">Failed to load students.</td></tr>`;
      }
    }

    function renderStudents(list){
      tbody.innerHTML='';
      if(!list.length){
        tbody.innerHTML=`<tr><td colspan="4" class="status">No students registered.</td></tr>`;
        return;
      }
      list.forEach((s,i)=>{
        const regId=s.userId||s.registrationId;
        const checked=attendanceMap[regId]===true?'checked':'';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${i+1}</td>
          <td>${s.name||'Unknown'}</td>
          <td>${s.rollNum||'-'}</td>
          <td style="text-align:center;">
            <input type="checkbox" class="presentBox" data-user="${regId}" ${checked}>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function saveAttendance(){
      const boxes=document.querySelectorAll('.presentBox');
      let success=0, fail=0;
      for(const cb of boxes){
        const userId=cb.dataset.user;
        const record={event:{id:+eventId}, user:userId?{id:+userId}:null, present:cb.checked};
        try{
          const res=await fetch('/attendance',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(record)
          });
          const data=await res.json().catch(()=>null);
          if(data&&(data.success===true||data.id))success++; else fail++;
        }catch{fail++;}
      }
      statusMsg.textContent=fail===0?'‚úÖ Attendance saved successfully!':`‚ö†Ô∏è Some records failed to save (${fail}).`;
      await loadStudents();
    }

    function goBack() {
  let cid = clubId || localStorage.getItem("clubId");

  if (cid) {
    window.location.href = `/club-dashboard.html?clubId=${cid}`;
  } else {
    alert("‚ö†Ô∏è Club ID missing ‚Äî returning to dashboard");
    window.location.href = "/club-dashboard.html";
  }
}



    document.getElementById('saveBtn').addEventListener('click',saveAttendance);
    loadEventInfo();
    loadStudents();
</script>
</body>
</html>





