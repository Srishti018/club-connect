<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBIT CLUB CONNECT ‚Äì Club Dashboard</title>
    <style>
        :root {
          --accent: #14b8a6;
          --accent-hover: #0d9488;
          --radius: 16px;
          --transition: all 0.3s ease;
          --shadow-3d: 0 8px 20px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08);

          /* Light */
          --bg: #f0f6ff;
          --card: #ffffff;
          --ink: #0f172a;
          --muted: #475569;
          --line: #dce3f0;
        }

        /* Dark */
        [data-theme="dark"] {
          --bg: #0b1622;
          --card: #142236;
          --ink: #e2e8f0;
          --muted: #94a3b8;
          --line: #1e293b;
          --shadow-3d: 0 10px 24px rgba(0,0,0,0.45), 0 6px 10px rgba(0,0,0,0.3);
        }

        *{box-sizing:border-box;transition:var(--transition);}
        body {
          background: var(--bg);
          color: var(--ink);
          font-family: "Inter", sans-serif;
          margin: 0;
          padding: 0;
        }

        /* Header */
        header {
          background: linear-gradient(90deg, var(--accent), var(--accent-hover));
          color: white;
          padding: 20px 30px;
          text-align: center;
          font-weight: 900;
          letter-spacing: 1px;
          font-size: 28px;
          text-transform: uppercase;
          box-shadow: var(--shadow-3d);
        }

        /* Container */
        .container {
          max-width: 1000px;
          margin: 40px auto;
          padding: 0 20px 40px;
        }

        /* Section */
        .section {
          background: var(--card);
          padding: 24px;
          border-radius: var(--radius);
          box-shadow: var(--shadow-3d);
          margin-bottom: 30px;
        }

        /* Title + Button */
        .section h2 {
          margin-top: 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: var(--accent);
          font-weight: 700;
        }
        .add-btn {
          background: linear-gradient(145deg, var(--accent), var(--accent-hover));
          color: #fff;
          border: none;
          border-radius: 10px;
          padding: 10px 16px;
          cursor: pointer;
          font-weight: 600;
          box-shadow: var(--shadow-3d);
        }
        .add-btn:hover { transform: translateY(-2px); }

        /* Event Cards */
        .event-card {
          background: var(--card);
          border: 1px solid var(--line);
          padding: 18px 20px;
          border-radius: 12px;
          margin-bottom: 18px;
          box-shadow: var(--shadow-3d);
        }
        .event-card h3 {
          margin: 0 0 8px 0;
          font-size: 20px;
          color: var(--accent);
        }
        .event-card p {
          margin: 6px 0;
          color: var(--muted);
          line-height: 1.4;
        }

        /* Buttons */
        .btn {
          padding: 8px 14px;
          border-radius: 8px;
          border: none;
          font-weight: 600;
          cursor: pointer;
          margin-right: 6px;
          transition: var(--transition);
        }
        .btn-primary {
          background: var(--accent);
          color: #fff;
        }
        .btn-primary:hover {
          background: var(--accent-hover);
          transform: translateY(-1px);
        }
        .btn-danger {
          background: #dc2626;
          color: #fff;
        }
        .btn-danger:hover { background: #b91c1c; }
        .btn-outline {
          background: transparent;
          border: 1.5px solid var(--accent);
          color: var(--accent);
        }
        .btn-outline:hover {
          background: var(--accent);
          color: #fff;
        }

        /* Popup Overlay */
        .popup-overlay {
          display: none;
          position: fixed;
          inset: 0;
          backdrop-filter: blur(8px);
          background: rgba(0, 0, 0, 0.5);
          justify-content: center;
          align-items: center;
          z-index: 10;
        }

        /* Popup */
        .popup {
          background: var(--card);
          padding: 26px;
          border-radius: var(--radius);
          width: 400px;
          box-shadow: var(--shadow-3d);
          color: var(--ink);
        }
        .popup h3 {
          margin-top: 0;
          color: var(--accent);
          text-align: center;
          font-weight: 700;
        }
        .popup input,
        .popup textarea {
          width: 100%;
          padding: 10px;
          margin: 6px 0;
          border-radius: 8px;
          border: 1px solid var(--line);
          background: var(--bg);
          color: var(--ink);
          font-size: 15px;
        }
        .popup input:focus,
        .popup textarea:focus {
          border-color: var(--accent);
          box-shadow: 0 0 0 3px rgba(20,184,166,0.25);
          outline: none;
        }
        .popup button { margin-top: 12px; }

        /* Theme Toggle */
        .theme-toggle {
          position: fixed;
          top: 20px;
          right: 20px;
          width: 44px;
          height: 44px;
          border-radius: 50%;
          border: none;
          cursor: pointer;
          background: var(--card);
          color: var(--ink);
          font-size: 20px;
          box-shadow: var(--shadow-3d);
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .theme-toggle:hover { transform: scale(1.05); }
    </style>
</head>

<body>
<header>CBIT CLUB CONNECT</header>
<button id="themeToggle" class="theme-toggle" title="Toggle theme">üåô</button>

<div class="container">
    <h1 id="clubName"></h1>

    <div class="section">
        <h2>Your Events <button class="add-btn" id="btnAdd">+ Add Event</button></h2>
        <div id="eventList"></div>
    </div>
</div>

<!-- Popup -->
<div class="popup-overlay" id="overlay">
    <div class="popup">
        <h3 id="popupTitle">Add Event</h3>
        <input type="text" id="eventName" placeholder="Event Name" />
        <input type="text" id="eventVenue" placeholder="Venue" />
        <input type="datetime-local" id="eventDateTime" />
        <input type="number" id="eventPoints" placeholder="Activity Points" />
        <textarea id="eventDesc" placeholder="Description"></textarea>
        <button class="btn btn-primary" id="btnSave">Save</button>
        <button class="btn btn-outline" id="btnCancel">Cancel</button>
    </div>
</div>

<script>
    /* --- Theme handling --- */
    const body=document.body;
    const toggle=document.getElementById("themeToggle");
    const saved=localStorage.getItem("theme");
    if(saved){
      body.setAttribute("data-theme",saved);
      toggle.textContent=saved==="dark"?"‚òÄÔ∏è":"üåô";
    }else if(window.matchMedia("(prefers-color-scheme: dark)").matches){
      body.setAttribute("data-theme","dark");
      toggle.textContent="‚òÄÔ∏è";
    }
    toggle.addEventListener("click",()=>{
      const now=body.getAttribute("data-theme");
      const next=now==="dark"?"light":"dark";
      body.setAttribute("data-theme",next);
      localStorage.setItem("theme",next);
      toggle.textContent=next==="dark"?"‚òÄÔ∏è":"üåô";
    });

    /* --- Dashboard Logic --- */
    const params=new URLSearchParams(window.location.search);
    const clubId=params.get("clubId");
    const clubName=params.get("clubName");
    document.getElementById("clubName").textContent=clubName||"";

    const eventList=document.getElementById("eventList");
    const overlay=document.getElementById("overlay");
    const btnAdd=document.getElementById("btnAdd");
    const btnSave=document.getElementById("btnSave");
    const btnCancel=document.getElementById("btnCancel");
    let editingId=null;

    async function loadEvents(){
      eventList.innerHTML="<p>Loading...</p>";
      try{
        const res=await fetch(`/api/events/by-club/${clubId}`);
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const events=await res.json();

        if(events.length===0){
          eventList.innerHTML="<p style='opacity:0.7;'>No events yet.</p>";
          return;
        }

        eventList.innerHTML=events.map(e=>`
          <div class="event-card">
            <h3>${e.name}</h3>
            <p><strong>üìç</strong> ${e.venue||'TBD'}<br>
            <strong>üïí</strong> ${new Date(e.startAt).toLocaleString()}<br>
            <strong>‚≠ê</strong> ${e.activityPoints??0} pts</p>
            <p>${e.description||''}</p>
            <button class="btn btn-outline" onclick="takeAttendance(${e.id})">Attendance</button>
            <button class="btn btn-primary" onclick="editEvent(${e.id})">Edit</button>
            <button class="btn btn-danger" onclick="deleteEvent(${e.id})">Delete</button>
          </div>
        `).join("");
      }catch(err){
        eventList.innerHTML=`<p style="color:red;">Failed: ${err}</p>`;
      }
    }

    async function deleteEvent(id){
      if(!confirm("Delete this event?"))return;
      try{
        const res=await fetch(`/api/events/${id}`,{method:"DELETE"});
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        loadEvents();
      }catch(err){alert("Failed: "+err.message);}
    }

    async function editEvent(id){
      try{
        const r=await fetch(`/api/events/by-club/${clubId}`);
        if(!r.ok)throw new Error(`HTTP ${r.status}`);
        const list=await r.json();
        const ev=list.find(e=>e.id===id);
        if(!ev){alert("Event not found.");return;}
        overlay.style.display='flex';
        document.getElementById('popupTitle').textContent="Edit Event";
        editingId=ev.id;
        document.getElementById('eventName').value=ev.name||"";
        document.getElementById('eventVenue').value=ev.venue||"";
        document.getElementById('eventDateTime').value=ev.startAt?new Date(ev.startAt).toISOString().slice(0,16):"";
        document.getElementById('eventPoints').value=ev.activityPoints??"";
        document.getElementById('eventDesc').value=ev.description||"";
      }catch(err){alert("Error loading event: "+err.message);}
    }

    btnAdd.onclick=()=>{
      overlay.style.display="flex";
      document.getElementById("popupTitle").textContent="Add Event";
      editingId=null;
      ['eventName','eventVenue','eventDateTime','eventPoints','eventDesc'].forEach(id=>document.getElementById(id).value="");
    };
    btnCancel.onclick=()=>overlay.style.display="none";

    btnSave.onclick=async()=>{
      const payload={
        name:document.getElementById("eventName").value,
        venue:document.getElementById("eventVenue").value,
        startAt:new Date(document.getElementById("eventDateTime").value),
        activityPoints:parseInt(document.getElementById("eventPoints").value||0),
        description:document.getElementById("eventDesc").value,
        clubId:parseInt(clubId)
      };
      const method=editingId?"PUT":"POST";
      const url=editingId?`/api/events/${editingId}`:`/api/events`;
      try{
        const res=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        overlay.style.display="none";
        loadEvents();
      }catch(err){alert("Save failed: "+err.message);}
    };

    function takeAttendance(id) {
  const url = `attendance.html?eventId=${id}&clubId=${clubId}`;
  localStorage.setItem("clubId", clubId); // backup if needed
  window.location.href = url;
}

    loadEvents();
</script>
</body>
</html>
